<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>5 in a row</title>
	<link rel="stylesheet" href="main.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<h1 class="result"> Grid Test </h1>
<div class="square"></div>
<!-- <div class="menu">
	<h1> test </h1>
	<h1> more tests </h1>
	<h1> more more tests </h1>
<div> -->
</div>
</body>

</html>

<script>

var mousedown = false;
var ipos;
var ibgpos;
var fingerDrag = false;
var squares = []

$('html').on('mousedown', startDragMouse).on('mouseup mouseleave', function() {
	mousedown = false;
});

$('html').on('mousemove', function(e) {
	if(mousedown) {dragMouse(e)}
});

$('html').on('click', click);

window.addEventListener("touchmove", dragFinger, {passive: false} );
window.addEventListener("touchstart", startDragFinger, {passive: false} );
window.addEventListener("touchend", endDragFinger, {passive: false} );
function getIBGpos() {
	let ibgposString = ($('html').css("background-position")).split(',')[0].split(" ")
	let pos = [Number(ibgposString[0].split("p")[0]), Number(ibgposString[1].split("p")[0])]
	return pos;
}

function startDragFinger(e) {
	console.log("Finger down")
	e.preventDefault();
	ibgpos = getIBGpos();
	let pos = e.changedTouches;
	ipos = [pos[0].pageX, pos[0].pageY]
}

function endDragFinger(e) {
	console.log("Finger up: " + fingerDrag);
	if (!fingerDrag) {
		let pos = e.changedTouches[0]
		click(pos);
	}
	fingerDrag = false;
}

function dragFinger(e) {
	console.log("Finger drag")
	fingerDrag = true;
	e.preventDefault()
	let pos = e.changedTouches
	let dx = pos[0].pageX - ipos[0]
	let dy = pos[0].pageY - ipos[1]
	moveGrid(dx,dy)
	moveSquares(dx,dy)
}

function startDragMouse(e) {
	mousedown = true;
	ibgpos = getIBGpos();
	ipos = [e.pageX, e.pageY]
}

function dragMouse(e) {
	let dx = e.pageX - ipos[0]
	let dy = e.pageY - ipos[1]
	moveGrid(dx,dy)
	moveSquares(dx,dy)
}

function click(e) {
	console.log("Clicked: " + e.pageX + ", " + e.pageY)
	let sq = new Square(e.pageX,e.pageY,"red")

}

function moveGrid(dx,dy) {
	var bgX = ibgpos[0] + dx
	var bgY = ibgpos[1] + dy
	$('html').css("background-position", bgX + "px " + bgY + "px");
	updateText(Math.floor(dx),Math.floor(dy))
}

function moveSquares(dx,dy) {
	for (i in squares) {
		squares[i].move(dx,dy)
	}
}

function updateText(one,two) {
	$('h1.result').html("(" + one + ", " + two + ")");
}

class Square {
	constructor(x,y,color) {
		this.x = x;
		this.y = y;
		this.color = color;
		this.id = squares.length;
		let ele = "<div class=\"square\" id=\"" + this.id + "\"></div>"
		$('body').append(ele)
		this.ele = $('#' + this.id)
		this.ele.css("left", this.x);
		this.ele.css("top", this.y);
		this.ele.css("background-color", this.color)
		console.log(this.ele)
		squares.push(this)
		console.log("constructed")
	}

	getPos() {
		let sq = $('#' + this.id)
		let pos = [Number(sq.css('left').split("p")[0]),Number(sq.css('top').split("p")[0])]
		return pos
	}

	move(dx,dy) {
		// if inaccurate, use getPos() instead of this.z
		this.x = this.x + dx;
		this.y = this.y + dy;
		this.ele.css("left", this.x + "px");
		this.ele.css("top", this.y + "px");
	}
}
</script>
