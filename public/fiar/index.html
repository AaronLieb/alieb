<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>5 in a row</title>
	<link rel="stylesheet" href="main.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<h1 class="result"> Grid Test </h1>
<!-- <div class="menu">
	<h1> test </h1>
	<h1> more tests </h1>
	<h1> more more tests </h1>
<div> -->
</div>
</body>

</html>

<script>

var mousedown = false;
var ipos;
var ibgpos;
var drag = false;
var squares = []

$('html').on('mousedown', startDrag).on('mouseup', endDrag);

$('html').on('mousemove', function(e) {
	if(mousedown) {isDrag(e)}
});

window.addEventListener("touchmove", isDrag, {passive: false} );
window.addEventListener("touchstart", startDrag, {passive: false} );
window.addEventListener("touchend", endDrag, {passive: false} );

function getIBGpos() {
	let ibgposString = ($('html').css("background-position")).split(',')[0].split(" ")
	let pos = [Number(ibgposString[0].split("p")[0]), Number(ibgposString[1].split("p")[0])]
	return pos;
}

function startDrag(e) {
	let pos;
	if (e.type.includes("touch")) {
		pos = e.changedTouches[0];
		e.preventDefault();
	} else {
		mousedown = true;
		pos = e;
	}
	ibgpos = getIBGpos();
	ipos = [pos.pageX, pos.pageY]
}

function endDrag(e) {
	let pos;
	if (e.type.includes("touch")) {
		pos = e.changedTouches[0]
	} else {
		pos = e;
		mousedown = false;
	}
	if (!drag) {
		click(pos);
	}
	drag = false;
	for (i in squares) {
		squares[i].moving = false;
	}

}

function isDrag(e) {
	let pos;
	if (e.type.includes("touch")) {
		pos = e.changedTouches[0];
			e.preventDefault();
	} else {
		pos = e;
	}
	drag = true;
	let dx = pos.pageX - ipos[0]
	let dy = pos.pageY - ipos[1]
	moveGrid(dx,dy)
	moveSquares(dx,dy)
}

function click(e) {
	console.log("Clicked: " + e.pageX + ", " + e.pageY)
	let sq = new Square(e.pageX,e.pageY,"blue")

}

function moveGrid(dx,dy) {
	var bgX = ibgpos[0] + dx
	var bgY = ibgpos[1] + dy
	$('html').css("background-position", bgX + "px " + bgY + "px");
	updateText(Math.floor(bgX),Math.floor(bgY))
}

function moveSquares(dx,dy) {
	for (i in squares) {
		squares[i].move(dx,dy)
	}
}

function updateText(one,two) {
	$('h1.result').html("(" + one + ", " + two + ")");
}

class Square {
	constructor(x,y,color) {
		let ibg = getIBGpos()
		let xsign = (x % 40 < ibg[0] % 40)
		let ysign = (y % 40 < ibg[1] % 40)
		let xsnap = x - (x % 40) - ((xsign * 40) - ibg[0] % 40)
		let ysnap = y - (y % 40) - ((ysign * 40) - ibg[1] % 40)
		this.x = xsnap;
		this.y = ysnap;
		console.log("Placed: " + this.x + ", " + this.y)
		this.xi = this.x;
		this.yi = this.y;
		this.moving = false;
		this.color = color;
		this.id = squares.length;
		let ele = "<div class=\"square\" id=\"" + this.id + "\"></div>"
		$('body').append(ele)
		this.ele = $('#' + this.id)
		this.ele.css("left", this.x + "px");
		this.ele.css("top", this.y + "px");
		this.ele.css("background-color", this.color)
		squares.push(this)
	}

	getPos() {
		let sq = $('#' + this.id)
		let pos = [Number(sq.css('left').split("p")[0]),Number(sq.css('top').split("p")[0])]
		return pos
	}

	move(dx,dy) {
		if (!this.moving) {
			this.xi = this.x;
			this.yi = this.y;
			this.moving = true;
		}
		this.x = this.xi + dx;
		this.y = this.yi + dy;

		this.ele.css("left", this.x + "px");
		this.ele.css("top", this.y + "px");
	}
}
</script>
